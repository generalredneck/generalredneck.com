# https://circleci.com/docs/configuration#machine
machine:
  timezone:
    America/Chicago
  php:
    # https://circleci.com/docs/build-image-trusty/#php
    version: 7.0.11
  environment:
    # In addition to the environment variables defined in this file, also
    # add the following variables in the Circle CI UI.
    #
    # See: https://circleci.com/docs/1.0/environment-variables/
    #
    # TERMINUS_SITE:  Name of the Pantheon site to run tests on, e.g. my_site
    # TERMINUS_TOKEN: The Pantheon machine token
    # GITHUB_TOKEN:   The GitHub personal access token
    # GIT_EMAIL:      The email address to use when making commits
    PATH: $PATH:~/bin:tests/scripts

dependencies:
  cache_directories:
    - ~/.composer/cache
  pre:
    - echo "Begin build"
    - |
      if [ -n "$GITHUB_TOKEN" ] ; then
        composer config --global github-oauth.github.com $GITHUB_TOKEN
      fi
    - git config --global user.email "$GIT_EMAIL"
    - git config --global user.name "Robo Redneck"
  override:
    - terminus auth:login -n --machine-token="$TERMINUS_TOKEN"
    # Do the stuff to build the site here to test.

test:
  override:
    echo "Tests here."

deployment:
  build-assets:
    branch: master
    commands:
      - terminus secrets:set -n "$TERMINUS_SITE.dev" token "$GITHUB_TOKEN" --file='github-secrets.json' --clear --skip-if-empty
      - terminus build-env:push-code "$TERMINUS_SITE.dev"
      - terminus drush -n $TERMINUS_SITE.dev -- local --yes
